<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TransformationPointFit.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Jacoco Report</a> &gt; <a href="index.source.html" class="el_package">algorithms.imageProcessing</a> &gt; <span class="el_source">TransformationPointFit.java</span></div><h1>TransformationPointFit.java</h1><pre class="source lang-java linenums">package algorithms.imageProcessing;

import algorithms.imageProcessing.transform.TransformationParameters;

/**
 *
 * @author nichole
 */
public class TransformationPointFit implements Comparable&lt;TransformationPointFit&gt; {
    
    private final TransformationParameters parameters;
    
    private final int nMatchedPoints;
    
<span class="nc" id="L15">    private int nMaxMatchable = 0;</span>
    
    private final double meanDistFromModel;
    
    private final double stDevFromMean;
    
<span class="nc" id="L21">    private float transTolX = Float.MAX_VALUE;</span>
    
<span class="nc" id="L23">    private float transTolY = Float.MAX_VALUE;</span>
    
    public TransformationPointFit(
        TransformationParameters theParameters, 
        int numberOfMatchedPoints, double theMeanDistFromModel, 
        double theStDevFromMean, float theTranslationXTolerance,
<span class="nc" id="L29">        float theTranslationYTolerance) {</span>
        
<span class="nc" id="L31">        parameters = theParameters;</span>
        
<span class="nc" id="L33">        nMatchedPoints = numberOfMatchedPoints;</span>
        
<span class="nc" id="L35">        meanDistFromModel = theMeanDistFromModel;</span>
        
<span class="nc" id="L37">        stDevFromMean = theStDevFromMean;</span>
        
<span class="nc" id="L39">        transTolX = theTranslationXTolerance;</span>
        
<span class="nc" id="L41">        transTolY = theTranslationYTolerance;</span>
<span class="nc" id="L42">    }</span>

    /**
     * @return the parameters
     */
    public TransformationParameters getParameters() {
<span class="nc" id="L48">        return parameters;</span>
    }
    
    public int getNumberOfMatchedPoints() {
<span class="nc" id="L52">        return nMatchedPoints;</span>
    }
    
    public float getRotationInRadians() {
<span class="nc bnc" id="L56" title="All 2 branches missed.">        if (parameters == null) {</span>
<span class="nc" id="L57">            return 0;</span>
        }
        
<span class="nc" id="L60">        return parameters.getRotationInRadians();</span>
    }
    
    public float getScale() {
<span class="nc bnc" id="L64" title="All 2 branches missed.">        if (parameters == null) {</span>
<span class="nc" id="L65">            return 0;</span>
        }
        
<span class="nc" id="L68">        return parameters.getScale();</span>
    }
    
    public float getTranslationX() {
<span class="nc bnc" id="L72" title="All 2 branches missed.">        if (parameters == null) {</span>
<span class="nc" id="L73">            return 0;</span>
        }
        
<span class="nc" id="L76">        return parameters.getTranslationX();</span>
    }
    
    public float getTranslationY() {
<span class="nc bnc" id="L80" title="All 2 branches missed.">        if (parameters == null) {</span>
<span class="nc" id="L81">            return 0;</span>
        }
        
<span class="nc" id="L84">        return parameters.getTranslationY();</span>
    }
    
    /**
     * tolerance used when including only residuals whose absolute value
     * is less than tolerance.
     * @return 
     */
    public float getTranslationXTolerance() {
<span class="nc" id="L93">        return transTolX;</span>
    }
    
    /**
     * tolerance used when including only residuals whose absolute value
     * is less than tolerance.
     * @return 
     */
    public float getTranslationYTolerance() {
<span class="nc" id="L102">        return transTolY;</span>
    }

    /**
     * @return the meanDistFromModel
     */
    public double getMeanDistFromModel() {
<span class="nc" id="L109">        return meanDistFromModel;</span>
    }

    /**
     * @return the stDevFromMean
     */
    public double getStDevFromMean() {
<span class="nc" id="L116">        return stDevFromMean;</span>
    }
    
    /**
     * @return the nMaxMatchable
     */
    public int getNMaxMatchable() {
<span class="nc" id="L123">        return nMaxMatchable;</span>
    }

    public void setTranslationXTolerance(float theTolerance) {
<span class="nc" id="L127">        transTolX = theTolerance;</span>
<span class="nc" id="L128">    }</span>
    
    public void setTranslationYTolerance(float theTolerance) {
<span class="nc" id="L131">        transTolY = theTolerance;</span>
<span class="nc" id="L132">    }</span>
    
    /**
     * @param maximumNumberMatchable the nMaxMatchable to set
     */
    public void setMaximumNumberMatchable(int maximumNumberMatchable) {
<span class="nc" id="L138">        this.nMaxMatchable = maximumNumberMatchable;</span>
<span class="nc" id="L139">    }</span>
    
    /**
     * compare object other to this instance and return -1 if this instance
     * is &quot;better&quot;, 0 if they are equal, else 1 if other is &quot;better&quot;.
     * @param other
     * @return 
     */
    @Override
    public int compareTo(TransformationPointFit other) {
    
<span class="nc bnc" id="L150" title="All 2 branches missed.">        if (other == null) {</span>
<span class="nc" id="L151">            return -1;</span>
        }
<span class="nc bnc" id="L153" title="All 4 branches missed.">        if ((other.getNumberOfMatchedPoints() == 0) &amp;&amp; (nMatchedPoints &gt; 0)) {</span>
<span class="nc" id="L154">            return -1;</span>
        }
<span class="nc bnc" id="L156" title="All 4 branches missed.">        if (Double.isNaN(other.getStDevFromMean()) &amp;&amp; !Double.isNaN(stDevFromMean)) {</span>
<span class="nc" id="L157">            return -1;</span>
        }
<span class="nc bnc" id="L159" title="All 4 branches missed.">        if ((other.getStDevFromMean() == Double.MAX_VALUE) &amp;&amp; </span>
            (stDevFromMean != Double.MAX_VALUE)) {
<span class="nc" id="L161">            return -1;</span>
        }
<span class="nc bnc" id="L163" title="All 4 branches missed.">        if ((other.getNumberOfMatchedPoints() &gt; 0) &amp;&amp; (nMatchedPoints == 0)) {</span>
<span class="nc" id="L164">            return 1;</span>
        }
<span class="nc bnc" id="L166" title="All 4 branches missed.">        if (!Double.isNaN(other.getStDevFromMean()) &amp;&amp; Double.isNaN(stDevFromMean)) {</span>
<span class="nc" id="L167">            return 1;</span>
        }
<span class="nc bnc" id="L169" title="All 4 branches missed.">        if ((other.getStDevFromMean() != Double.MAX_VALUE) &amp;&amp; </span>
            (stDevFromMean == Double.MAX_VALUE)) {
<span class="nc" id="L171">            return 1;</span>
        }
        
<span class="nc" id="L174">        TransformationPointFit compareFit = other;</span>
        
<span class="nc" id="L176">        int compNMatches = compareFit.getNumberOfMatchedPoints();</span>
<span class="nc" id="L177">        int bestNMatches = nMatchedPoints;</span>

<span class="nc" id="L179">        double compAvg = compareFit.getMeanDistFromModel();</span>
<span class="nc" id="L180">        double bestAvg = meanDistFromModel;</span>
<span class="nc" id="L181">        double diffAvg = Math.abs(compAvg - bestAvg);</span>

<span class="nc" id="L183">        double compS = compareFit.getStDevFromMean();</span>
<span class="nc" id="L184">        double bestS = stDevFromMean;</span>
<span class="nc" id="L185">        double diffS = Math.abs(compS - bestS);</span>

<span class="nc" id="L187">        double avgDiv = bestAvg/compAvg;</span>

<span class="nc" id="L189">        int diffEps = (int)Math.ceil(Math.max(bestNMatches, compNMatches)/10.);</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">        if (diffEps == 0) {</span>
<span class="nc" id="L191">            diffEps = 1;</span>
        }

<span class="nc bnc" id="L194" title="All 2 branches missed.">        if (Math.abs(bestNMatches - compNMatches) &lt;= diffEps) {</span>

<span class="nc bnc" id="L196" title="All 2 branches missed.">            if (Double.isNaN(compareFit.getMeanDistFromModel())) {</span>
<span class="nc" id="L197">                return -1;</span>
            }
            
<span class="nc bnc" id="L200" title="All 2 branches missed.">            if (compAvg &lt; bestAvg) {</span>
<span class="nc" id="L201">                return 1;</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">            } else if (compAvg &gt; bestAvg) {</span>
<span class="nc" id="L203">                return -1;</span>
            }

<span class="nc bnc" id="L206" title="All 2 branches missed.">            if (compS &lt; bestS) {</span>
<span class="nc" id="L207">                return 1;</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">            } else if (compS &gt; bestS) {</span>
<span class="nc" id="L209">                return -1;</span>
            }
            
<span class="nc bnc" id="L212" title="All 2 branches missed.">        } else if (compNMatches &gt; bestNMatches) {</span>

<span class="nc" id="L214">            return 1;</span>
        }
        
<span class="nc" id="L217">        return -1;</span>
    }

    /**
     * compare object other to this instance and return -1 if this instance
     * is &quot;better&quot;, 0 if they are equal, else 1 if other is &quot;better&quot;.
     * Uses the same logic as compareTo, except replaces nMatched with
     * nMatched/nMaxMatchable.
     * @param other
     * @return 
     */
    public int compareToUsingNormalizedMatches(TransformationPointFit other) {
    
<span class="nc bnc" id="L230" title="All 2 branches missed.">        if (other == null) {</span>
<span class="nc" id="L231">            return -1;</span>
        }
<span class="nc bnc" id="L233" title="All 4 branches missed.">        if ((other.getNumberOfMatchedPoints() == 0) &amp;&amp; (nMatchedPoints &gt; 0)) {</span>
<span class="nc" id="L234">            return -1;</span>
        }
<span class="nc bnc" id="L236" title="All 4 branches missed.">        if (Double.isNaN(other.getStDevFromMean()) &amp;&amp; !Double.isNaN(stDevFromMean)) {</span>
<span class="nc" id="L237">            return -1;</span>
        }
<span class="nc bnc" id="L239" title="All 4 branches missed.">        if ((other.getStDevFromMean() == Double.MAX_VALUE) &amp;&amp; </span>
            (stDevFromMean != Double.MAX_VALUE)) {
<span class="nc" id="L241">            return -1;</span>
        }
<span class="nc bnc" id="L243" title="All 4 branches missed.">        if ((other.getNumberOfMatchedPoints() &gt; 0) &amp;&amp; (nMatchedPoints == 0)) {</span>
<span class="nc" id="L244">            return 1;</span>
        }
<span class="nc bnc" id="L246" title="All 4 branches missed.">        if (!Double.isNaN(other.getStDevFromMean()) &amp;&amp; Double.isNaN(stDevFromMean)) {</span>
<span class="nc" id="L247">            return 1;</span>
        }
<span class="nc bnc" id="L249" title="All 4 branches missed.">        if ((other.getStDevFromMean() != Double.MAX_VALUE) &amp;&amp; </span>
            (stDevFromMean == Double.MAX_VALUE)) {
<span class="nc" id="L251">            return 1;</span>
        }
        
<span class="nc" id="L254">        TransformationPointFit compareFit = other;</span>
        
<span class="nc" id="L256">        float compNMatches = (float)compareFit.getNumberOfMatchedPoints()/</span>
<span class="nc" id="L257">            (float)compareFit.getNMaxMatchable();</span>
<span class="nc" id="L258">        float bestNMatches = (float)nMatchedPoints/(float)nMaxMatchable;</span>

<span class="nc" id="L260">        double compAvg = compareFit.getMeanDistFromModel();</span>
<span class="nc" id="L261">        double bestAvg = meanDistFromModel;</span>

<span class="nc" id="L263">        double compS = compareFit.getStDevFromMean();</span>
<span class="nc" id="L264">        double bestS = stDevFromMean;</span>

<span class="nc" id="L266">        double diffEps = Math.sqrt(Math.min(compareFit.getNMaxMatchable(),</span>
            nMaxMatchable));
<span class="nc" id="L268">        diffEps = 1./(10.*diffEps);</span>

<span class="nc bnc" id="L270" title="All 2 branches missed.">        if (Math.abs(bestNMatches - compNMatches) &lt;= diffEps) {</span>

<span class="nc bnc" id="L272" title="All 2 branches missed.">            if (Double.isNaN(compareFit.getMeanDistFromModel())) {</span>
<span class="nc" id="L273">                return -1;</span>
            }
            
<span class="nc bnc" id="L276" title="All 2 branches missed.">            if (compAvg &lt; bestAvg) {</span>
<span class="nc" id="L277">                return 1;</span>
<span class="nc bnc" id="L278" title="All 2 branches missed.">            } else if (compAvg &gt; bestAvg) {</span>
<span class="nc" id="L279">                return -1;</span>
            }

<span class="nc bnc" id="L282" title="All 2 branches missed.">            if (compS &lt; bestS) {</span>
<span class="nc" id="L283">                return 1;</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">            } else if (compS &gt; bestS) {</span>
<span class="nc" id="L285">                return -1;</span>
            }
            
<span class="nc bnc" id="L288" title="All 2 branches missed.">        } else if (compNMatches &gt; bestNMatches) {</span>

<span class="nc" id="L290">            return 1;</span>
        }
        
<span class="nc" id="L293">        return -1;</span>
    }

    @Override
    public String toString() {
        
<span class="nc" id="L299">        StringBuilder sb = new StringBuilder();</span>
        
<span class="nc" id="L301">        sb.append(&quot;\nnMatchedPoints=&quot;).append(Integer.toString(nMatchedPoints))</span>
<span class="nc" id="L302">            .append(&quot; nMaxMatchable=&quot;)</span>
<span class="nc" id="L303">            .append(Double.toString(nMaxMatchable))</span>
<span class="nc" id="L304">            .append(&quot;\nmeanDistFromModel=&quot;)</span>
<span class="nc" id="L305">            .append(Double.toString(meanDistFromModel))</span>
<span class="nc" id="L306">            .append(&quot; stDevFromMean=&quot;)</span>
<span class="nc" id="L307">            .append(Double.toString(stDevFromMean))</span>
<span class="nc" id="L308">            .append(&quot;\ntranslationXTolerance=&quot;)</span>
<span class="nc" id="L309">            .append(Float.toString(transTolX))</span>
<span class="nc" id="L310">            .append(&quot; translationYTolerance=&quot;)</span>
<span class="nc" id="L311">            .append(Float.toString(transTolY))</span>
<span class="nc" id="L312">            .append(&quot;\n&quot;)</span>
<span class="nc" id="L313">            .append(parameters.toString());</span>
        
<span class="nc" id="L315">        return sb.toString();</span>
    }

    public int isSimilarWithDiffParameters(TransformationPointFit compareFit) {
        
        /*if the fit and bestFit is very close,
        need an infrastructure to return more than one
        (and to reset it when another fit not similar to bestFit is found)

        bestFit:
            fit=nMatchedPoints=63 nMaxMatchable=63.0
            meanDistFromModel=37.57523582095192
            stDevFromMean=22.616214121394517
            tolerance=144.2497833620557
            rotationInRadians=0.34906584
            rotationInDegrees=19.99999941818584
            scale=1.0
            translationX=86.61143 translationY=-18.330833

        fit:
            fit=nMatchedPoints=63 nMaxMatchable=63.0
            meanDistFromModel=36.79744166041177            &lt;-- mean dist and stdev are similar
            stDevFromMean=23.167906020816925
            tolerance=144.2497833620557
            rotationInRadians=0.5235988
            rotationInDegrees=30.000000834826057            &lt;--- rot is very different
            scale=1.0
            translationX=91.6094 translationY=-72.9244      &lt;--- transY is very different

        the correct answer is closer to &quot;bestFit&quot; but is currently
        then replaced with fit, so need to preserve both.

        correct answer:
            rotationInDegrees=18.000000500895634
            scale=1.0
            translationX=7.0 translationY=33.0
            number of vertical partitions=3

        ----
        in contrast, these 2 sets of meanDistFromModel and stDevFromMean
        are significantly different:
            bestFit: meanDistFromModel=0.3658992320831333 stDevFromMean=0.15709856816653883
            fit:     meanDistFromModel=2.267763360270432 stDevFromMean=1.0703222291650063
        -----
        so ratios are needed rather than differences
        similar fits:    divMean = 1.02
                         divStDev = 0.976
        different fits:  divMean = 0.161
                         divStDev = 0.147
        */

        //TODO: this may need to be adjusted and in the 2 fitness
        // functions which use it... should be it's own method...
<span class="nc" id="L368">        int nEps = (int)(1.5*Math.ceil(nMatchedPoints/10.));</span>
<span class="nc bnc" id="L369" title="All 2 branches missed.">        if (nEps == 0) {</span>
<span class="nc" id="L370">            nEps = 1;</span>
        }

<span class="nc" id="L373">        int diffNMatched = Math.abs(nMatchedPoints -</span>
<span class="nc" id="L374">            compareFit.getNumberOfMatchedPoints());</span>

<span class="nc bnc" id="L376" title="All 2 branches missed.">        if (diffNMatched &gt; nEps) {</span>
<span class="nc" id="L377">            return -1;</span>
        }

<span class="nc" id="L380">        double divMean = Math.abs(meanDistFromModel/</span>
<span class="nc" id="L381">            compareFit.getMeanDistFromModel());</span>

<span class="nc" id="L383">        double divStDev = Math.abs(stDevFromMean/compareFit.getStDevFromMean());</span>

<span class="nc bnc" id="L385" title="All 4 branches missed.">        if ((Math.abs(1 - divMean) &lt; 0.05) &amp;&amp; (Math.abs(1 - divStDev) &lt; 0.3)) {</span>
<span class="nc bnc" id="L386" title="All 2 branches missed.">            if (parameters.equals(compareFit.getParameters())) {</span>
<span class="nc" id="L387">                return 0;</span>
            } else {
<span class="nc" id="L389">                return 1;</span>
            }
        }

<span class="nc" id="L393">        return -1;</span>
    }

    public int isSimilarNormalizedWithDiffParameters(TransformationPointFit compareFit) {
        
<span class="nc" id="L398">        float compNMatches = (float)compareFit.getNumberOfMatchedPoints()/</span>
<span class="nc" id="L399">            (float)compareFit.getNMaxMatchable();</span>
<span class="nc" id="L400">        float bestNMatches = (float)nMatchedPoints/(float)nMaxMatchable;</span>
        
<span class="nc" id="L402">        double diffEps = Math.sqrt(Math.min(compareFit.getNMaxMatchable(),</span>
            nMaxMatchable));
<span class="nc" id="L404">        diffEps = 1./(10.*diffEps);</span>

<span class="nc bnc" id="L406" title="All 2 branches missed.">        if (Math.abs(bestNMatches - compNMatches) &gt; diffEps) {</span>
<span class="nc" id="L407">            return -1;</span>
        }

<span class="nc" id="L410">        double divMean = Math.abs(meanDistFromModel/</span>
<span class="nc" id="L411">            compareFit.getMeanDistFromModel());</span>

<span class="nc" id="L413">        double divStDev = Math.abs(stDevFromMean/compareFit.getStDevFromMean());</span>

<span class="nc bnc" id="L415" title="All 4 branches missed.">        if ((Math.abs(1 - divMean) &lt; 0.05) &amp;&amp; (Math.abs(1 - divStDev) &lt; 0.3)) {</span>
<span class="nc bnc" id="L416" title="All 2 branches missed.">            if (parameters.equals(compareFit.getParameters())) {</span>
<span class="nc" id="L417">                return 0;</span>
            } else {
<span class="nc" id="L419">                return 1;</span>
            }
        }

<span class="nc" id="L423">        return -1;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>