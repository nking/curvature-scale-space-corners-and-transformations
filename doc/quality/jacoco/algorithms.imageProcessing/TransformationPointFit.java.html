<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TransformationPointFit.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Jacoco Report</a> &gt; <a href="index.source.html" class="el_package">algorithms.imageProcessing</a> &gt; <span class="el_source">TransformationPointFit.java</span></div><h1>TransformationPointFit.java</h1><pre class="source lang-java linenums">package algorithms.imageProcessing;

/**
 *
 * @author nichole
 */
public class TransformationPointFit implements Comparable&lt;TransformationPointFit&gt; {
    
    private final TransformationParameters parameters;
    
    private final int nMatchedPoints;
    
<span class="fc" id="L13">    private int nMaxMatchable = 0;</span>
    
    private final double meanDistFromModel;
    
    private final double stDevFromMean;
    
<span class="fc" id="L19">    private float transTolX = Float.MAX_VALUE;</span>
    
<span class="fc" id="L21">    private float transTolY = Float.MAX_VALUE;</span>
    
    public TransformationPointFit(
        TransformationParameters theParameters, 
        int numberOfMatchedPoints, double theMeanDistFromModel, 
        double theStDevFromMean, float theTranslationXTolerance,
<span class="fc" id="L27">        float theTranslationYTolerance) {</span>
        
<span class="fc" id="L29">        parameters = theParameters;</span>
        
<span class="fc" id="L31">        nMatchedPoints = numberOfMatchedPoints;</span>
        
<span class="fc" id="L33">        meanDistFromModel = theMeanDistFromModel;</span>
        
<span class="fc" id="L35">        stDevFromMean = theStDevFromMean;</span>
        
<span class="fc" id="L37">        transTolX = theTranslationXTolerance;</span>
        
<span class="fc" id="L39">        transTolY = theTranslationYTolerance;</span>
<span class="fc" id="L40">    }</span>

    /**
     * @return the parameters
     */
    public TransformationParameters getParameters() {
<span class="fc" id="L46">        return parameters;</span>
    }
    
    public int getNumberOfMatchedPoints() {
<span class="fc" id="L50">        return nMatchedPoints;</span>
    }
    
    public float getRotationInRadians() {
<span class="pc bpc" id="L54" title="1 of 2 branches missed.">        if (parameters == null) {</span>
<span class="nc" id="L55">            return 0;</span>
        }
        
<span class="fc" id="L58">        return parameters.getRotationInRadians();</span>
    }
    
    public float getScale() {
<span class="pc bpc" id="L62" title="1 of 2 branches missed.">        if (parameters == null) {</span>
<span class="nc" id="L63">            return 0;</span>
        }
        
<span class="fc" id="L66">        return parameters.getScale();</span>
    }
    
    public float getTranslationX() {
<span class="pc bpc" id="L70" title="1 of 2 branches missed.">        if (parameters == null) {</span>
<span class="nc" id="L71">            return 0;</span>
        }
        
<span class="fc" id="L74">        return parameters.getTranslationX();</span>
    }
    
    public float getTranslationY() {
<span class="pc bpc" id="L78" title="1 of 2 branches missed.">        if (parameters == null) {</span>
<span class="nc" id="L79">            return 0;</span>
        }
        
<span class="fc" id="L82">        return parameters.getTranslationY();</span>
    }
    
    /**
     * tolerance used when including only residuals whose absolute value
     * is less than tolerance.
     * @return 
     */
    public float getTranslationXTolerance() {
<span class="fc" id="L91">        return transTolX;</span>
    }
    
    /**
     * tolerance used when including only residuals whose absolute value
     * is less than tolerance.
     * @return 
     */
    public float getTranslationYTolerance() {
<span class="fc" id="L100">        return transTolY;</span>
    }

    /**
     * @return the meanDistFromModel
     */
    public double getMeanDistFromModel() {
<span class="fc" id="L107">        return meanDistFromModel;</span>
    }

    /**
     * @return the stDevFromMean
     */
    public double getStDevFromMean() {
<span class="fc" id="L114">        return stDevFromMean;</span>
    }
    
    /**
     * @return the nMaxMatchable
     */
    public int getNMaxMatchable() {
<span class="fc" id="L121">        return nMaxMatchable;</span>
    }

    public void setTranslationXTolerance(float theTolerance) {
<span class="nc" id="L125">        transTolX = theTolerance;</span>
<span class="nc" id="L126">    }</span>
    
    public void setTranslationYTolerance(float theTolerance) {
<span class="nc" id="L129">        transTolY = theTolerance;</span>
<span class="nc" id="L130">    }</span>
    
    /**
     * @param maximumNumberMatchable the nMaxMatchable to set
     */
    public void setMaximumNumberMatchable(int maximumNumberMatchable) {
<span class="fc" id="L136">        this.nMaxMatchable = maximumNumberMatchable;</span>
<span class="fc" id="L137">    }</span>
    
    /**
     * compare object other to this instance and return -1 if this instance
     * is &quot;better&quot;, 0 if they are equal, else 1 if other is &quot;better&quot;.
     * @param other
     * @return 
     */
    @Override
    public int compareTo(TransformationPointFit other) {
    
<span class="pc bpc" id="L148" title="1 of 2 branches missed.">        if (other == null) {</span>
<span class="nc" id="L149">            return -1;</span>
        }
<span class="fc bfc" id="L151" title="All 4 branches covered.">        if ((other.getNumberOfMatchedPoints() == 0) &amp;&amp; (nMatchedPoints &gt; 0)) {</span>
<span class="fc" id="L152">            return -1;</span>
        }
<span class="fc bfc" id="L154" title="All 4 branches covered.">        if (Double.isNaN(other.getStDevFromMean()) &amp;&amp; !Double.isNaN(stDevFromMean)) {</span>
<span class="fc" id="L155">            return -1;</span>
        }
<span class="pc bpc" id="L157" title="1 of 4 branches missed.">        if ((other.getStDevFromMean() == Double.MAX_VALUE) &amp;&amp; </span>
            (stDevFromMean != Double.MAX_VALUE)) {
<span class="nc" id="L159">            return -1;</span>
        }
<span class="fc bfc" id="L161" title="All 4 branches covered.">        if ((other.getNumberOfMatchedPoints() &gt; 0) &amp;&amp; (nMatchedPoints == 0)) {</span>
<span class="fc" id="L162">            return 1;</span>
        }
<span class="fc bfc" id="L164" title="All 4 branches covered.">        if (!Double.isNaN(other.getStDevFromMean()) &amp;&amp; Double.isNaN(stDevFromMean)) {</span>
<span class="fc" id="L165">            return 1;</span>
        }
<span class="pc bpc" id="L167" title="1 of 4 branches missed.">        if ((other.getStDevFromMean() != Double.MAX_VALUE) &amp;&amp; </span>
            (stDevFromMean == Double.MAX_VALUE)) {
<span class="nc" id="L169">            return 1;</span>
        }
        
<span class="fc" id="L172">        TransformationPointFit compareFit = other;</span>
        
<span class="fc" id="L174">        int compNMatches = compareFit.getNumberOfMatchedPoints();</span>
<span class="fc" id="L175">        int bestNMatches = nMatchedPoints;</span>

<span class="fc" id="L177">        double compAvg = compareFit.getMeanDistFromModel();</span>
<span class="fc" id="L178">        double bestAvg = meanDistFromModel;</span>
<span class="fc" id="L179">        double diffAvg = Math.abs(compAvg - bestAvg);</span>

<span class="fc" id="L181">        double compS = compareFit.getStDevFromMean();</span>
<span class="fc" id="L182">        double bestS = stDevFromMean;</span>
<span class="fc" id="L183">        double diffS = Math.abs(compS - bestS);</span>

<span class="fc" id="L185">        double avgDiv = bestAvg/compAvg;</span>

<span class="fc" id="L187">        int diffEps = (int)Math.ceil(Math.max(bestNMatches, compNMatches)/10.);</span>
<span class="fc bfc" id="L188" title="All 2 branches covered.">        if (diffEps == 0) {</span>
<span class="fc" id="L189">            diffEps = 1;</span>
        }

<span class="fc bfc" id="L192" title="All 2 branches covered.">        if (Math.abs(bestNMatches - compNMatches) &lt;= diffEps) {</span>

<span class="pc bpc" id="L194" title="1 of 2 branches missed.">            if (Double.isNaN(compareFit.getMeanDistFromModel())) {</span>
<span class="nc" id="L195">                return -1;</span>
            }
            
<span class="fc bfc" id="L198" title="All 2 branches covered.">            if (compAvg &lt; bestAvg) {</span>
<span class="fc" id="L199">                return 1;</span>
<span class="fc bfc" id="L200" title="All 2 branches covered.">            } else if (compAvg &gt; bestAvg) {</span>
<span class="fc" id="L201">                return -1;</span>
            }

<span class="fc bfc" id="L204" title="All 2 branches covered.">            if (compS &lt; bestS) {</span>
<span class="fc" id="L205">                return 1;</span>
<span class="fc bfc" id="L206" title="All 2 branches covered.">            } else if (compS &gt; bestS) {</span>
<span class="fc" id="L207">                return -1;</span>
            }
            
<span class="fc bfc" id="L210" title="All 2 branches covered.">        } else if (compNMatches &gt; bestNMatches) {</span>

<span class="fc" id="L212">            return 1;</span>
        }
        
<span class="fc" id="L215">        return -1;</span>
    }

    /**
     * compare object other to this instance and return -1 if this instance
     * is &quot;better&quot;, 0 if they are equal, else 1 if other is &quot;better&quot;.
     * Uses the same logic as compareTo, except replaces nMatched with
     * nMatched/nMaxMatchable.
     * @param other
     * @return 
     */
    public int compareToUsingNormalizedMatches(TransformationPointFit other) {
    
<span class="pc bpc" id="L228" title="1 of 2 branches missed.">        if (other == null) {</span>
<span class="nc" id="L229">            return -1;</span>
        }
<span class="pc bpc" id="L231" title="3 of 4 branches missed.">        if ((other.getNumberOfMatchedPoints() == 0) &amp;&amp; (nMatchedPoints &gt; 0)) {</span>
<span class="nc" id="L232">            return -1;</span>
        }
<span class="pc bpc" id="L234" title="3 of 4 branches missed.">        if (Double.isNaN(other.getStDevFromMean()) &amp;&amp; !Double.isNaN(stDevFromMean)) {</span>
<span class="nc" id="L235">            return -1;</span>
        }
<span class="pc bpc" id="L237" title="3 of 4 branches missed.">        if ((other.getStDevFromMean() == Double.MAX_VALUE) &amp;&amp; </span>
            (stDevFromMean != Double.MAX_VALUE)) {
<span class="nc" id="L239">            return -1;</span>
        }
<span class="pc bpc" id="L241" title="2 of 4 branches missed.">        if ((other.getNumberOfMatchedPoints() &gt; 0) &amp;&amp; (nMatchedPoints == 0)) {</span>
<span class="nc" id="L242">            return 1;</span>
        }
<span class="pc bpc" id="L244" title="2 of 4 branches missed.">        if (!Double.isNaN(other.getStDevFromMean()) &amp;&amp; Double.isNaN(stDevFromMean)) {</span>
<span class="nc" id="L245">            return 1;</span>
        }
<span class="pc bpc" id="L247" title="2 of 4 branches missed.">        if ((other.getStDevFromMean() != Double.MAX_VALUE) &amp;&amp; </span>
            (stDevFromMean == Double.MAX_VALUE)) {
<span class="nc" id="L249">            return 1;</span>
        }
        
<span class="fc" id="L252">        TransformationPointFit compareFit = other;</span>
        
<span class="fc" id="L254">        float compNMatches = (float)compareFit.getNumberOfMatchedPoints()/</span>
<span class="fc" id="L255">            (float)compareFit.getNMaxMatchable();</span>
<span class="fc" id="L256">        float bestNMatches = (float)nMatchedPoints/(float)nMaxMatchable;</span>

<span class="fc" id="L258">        double compAvg = compareFit.getMeanDistFromModel();</span>
<span class="fc" id="L259">        double bestAvg = meanDistFromModel;</span>

<span class="fc" id="L261">        double compS = compareFit.getStDevFromMean();</span>
<span class="fc" id="L262">        double bestS = stDevFromMean;</span>

<span class="fc" id="L264">        double diffEps = Math.sqrt(Math.min(compareFit.getNMaxMatchable(),</span>
            nMaxMatchable));
<span class="fc" id="L266">        diffEps = 1./(10.*diffEps);</span>

<span class="fc bfc" id="L268" title="All 2 branches covered.">        if (Math.abs(bestNMatches - compNMatches) &lt;= diffEps) {</span>

<span class="pc bpc" id="L270" title="1 of 2 branches missed.">            if (Double.isNaN(compareFit.getMeanDistFromModel())) {</span>
<span class="nc" id="L271">                return -1;</span>
            }
            
<span class="fc bfc" id="L274" title="All 2 branches covered.">            if (compAvg &lt; bestAvg) {</span>
<span class="fc" id="L275">                return 1;</span>
<span class="fc bfc" id="L276" title="All 2 branches covered.">            } else if (compAvg &gt; bestAvg) {</span>
<span class="fc" id="L277">                return -1;</span>
            }

<span class="pc bpc" id="L280" title="1 of 2 branches missed.">            if (compS &lt; bestS) {</span>
<span class="nc" id="L281">                return 1;</span>
<span class="fc bfc" id="L282" title="All 2 branches covered.">            } else if (compS &gt; bestS) {</span>
<span class="fc" id="L283">                return -1;</span>
            }
            
<span class="fc bfc" id="L286" title="All 2 branches covered.">        } else if (compNMatches &gt; bestNMatches) {</span>

<span class="fc" id="L288">            return 1;</span>
        }
        
<span class="fc" id="L291">        return -1;</span>
    }

    @Override
    public String toString() {
        
<span class="fc" id="L297">        StringBuilder sb = new StringBuilder();</span>
        
<span class="fc" id="L299">        sb.append(&quot;\nnMatchedPoints=&quot;).append(Integer.toString(nMatchedPoints))</span>
<span class="fc" id="L300">            .append(&quot; nMaxMatchable=&quot;)</span>
<span class="fc" id="L301">            .append(Double.toString(nMaxMatchable))</span>
<span class="fc" id="L302">            .append(&quot;\nmeanDistFromModel=&quot;)</span>
<span class="fc" id="L303">            .append(Double.toString(meanDistFromModel))</span>
<span class="fc" id="L304">            .append(&quot; stDevFromMean=&quot;)</span>
<span class="fc" id="L305">            .append(Double.toString(stDevFromMean))</span>
<span class="fc" id="L306">            .append(&quot;\ntranslationXTolerance=&quot;)</span>
<span class="fc" id="L307">            .append(Float.toString(transTolX))</span>
<span class="fc" id="L308">            .append(&quot; translationYTolerance=&quot;)</span>
<span class="fc" id="L309">            .append(Float.toString(transTolY))</span>
<span class="fc" id="L310">            .append(&quot;\n&quot;)</span>
<span class="fc" id="L311">            .append(parameters.toString());</span>
        
<span class="fc" id="L313">        return sb.toString();</span>
    }

    public int isSimilarWithDiffParameters(TransformationPointFit compareFit) {
        
        /*if the fit and bestFit is very close,
        need an infrastructure to return more than one
        (and to reset it when another fit not similar to bestFit is found)

        bestFit:
            fit=nMatchedPoints=63 nMaxMatchable=63.0
            meanDistFromModel=37.57523582095192
            stDevFromMean=22.616214121394517
            tolerance=144.2497833620557
            rotationInRadians=0.34906584
            rotationInDegrees=19.99999941818584
            scale=1.0
            translationX=86.61143 translationY=-18.330833

        fit:
            fit=nMatchedPoints=63 nMaxMatchable=63.0
            meanDistFromModel=36.79744166041177            &lt;-- mean dist and stdev are similar
            stDevFromMean=23.167906020816925
            tolerance=144.2497833620557
            rotationInRadians=0.5235988
            rotationInDegrees=30.000000834826057            &lt;--- rot is very different
            scale=1.0
            translationX=91.6094 translationY=-72.9244      &lt;--- transY is very different

        the correct answer is closer to &quot;bestFit&quot; but is currently
        then replaced with fit, so need to preserve both.

        correct answer:
            rotationInDegrees=18.000000500895634
            scale=1.0
            translationX=7.0 translationY=33.0
            number of vertical partitions=3

        ----
        in contrast, these 2 sets of meanDistFromModel and stDevFromMean
        are significantly different:
            bestFit: meanDistFromModel=0.3658992320831333 stDevFromMean=0.15709856816653883
            fit:     meanDistFromModel=2.267763360270432 stDevFromMean=1.0703222291650063
        -----
        so ratios are needed rather than differences
        similar fits:    divMean = 1.02
                         divStDev = 0.976
        different fits:  divMean = 0.161
                         divStDev = 0.147
        */

        //TODO: this may need to be adjusted and in the 2 fitness
        // functions which use it... should be it's own method...
<span class="nc" id="L366">        int nEps = (int)(1.5*Math.ceil(nMatchedPoints/10.));</span>
<span class="nc bnc" id="L367" title="All 2 branches missed.">        if (nEps == 0) {</span>
<span class="nc" id="L368">            nEps = 1;</span>
        }

<span class="nc" id="L371">        int diffNMatched = Math.abs(nMatchedPoints -</span>
<span class="nc" id="L372">            compareFit.getNumberOfMatchedPoints());</span>

<span class="nc bnc" id="L374" title="All 2 branches missed.">        if (diffNMatched &gt; nEps) {</span>
<span class="nc" id="L375">            return -1;</span>
        }

<span class="nc" id="L378">        double divMean = Math.abs(meanDistFromModel/</span>
<span class="nc" id="L379">            compareFit.getMeanDistFromModel());</span>

<span class="nc" id="L381">        double divStDev = Math.abs(stDevFromMean/compareFit.getStDevFromMean());</span>

<span class="nc bnc" id="L383" title="All 4 branches missed.">        if ((Math.abs(1 - divMean) &lt; 0.05) &amp;&amp; (Math.abs(1 - divStDev) &lt; 0.3)) {</span>
<span class="nc bnc" id="L384" title="All 2 branches missed.">            if (parameters.equals(compareFit.getParameters())) {</span>
<span class="nc" id="L385">                return 0;</span>
            } else {
<span class="nc" id="L387">                return 1;</span>
            }
        }

<span class="nc" id="L391">        return -1;</span>
    }

    public int isSimilarNormalizedWithDiffParameters(TransformationPointFit compareFit) {
        
<span class="nc" id="L396">        float compNMatches = (float)compareFit.getNumberOfMatchedPoints()/</span>
<span class="nc" id="L397">            (float)compareFit.getNMaxMatchable();</span>
<span class="nc" id="L398">        float bestNMatches = (float)nMatchedPoints/(float)nMaxMatchable;</span>
        
<span class="nc" id="L400">        double diffEps = Math.sqrt(Math.min(compareFit.getNMaxMatchable(),</span>
            nMaxMatchable));
<span class="nc" id="L402">        diffEps = 1./(10.*diffEps);</span>

<span class="nc bnc" id="L404" title="All 2 branches missed.">        if (Math.abs(bestNMatches - compNMatches) &gt; diffEps) {</span>
<span class="nc" id="L405">            return -1;</span>
        }

<span class="nc" id="L408">        double divMean = Math.abs(meanDistFromModel/</span>
<span class="nc" id="L409">            compareFit.getMeanDistFromModel());</span>

<span class="nc" id="L411">        double divStDev = Math.abs(stDevFromMean/compareFit.getStDevFromMean());</span>

<span class="nc bnc" id="L413" title="All 4 branches missed.">        if ((Math.abs(1 - divMean) &lt; 0.05) &amp;&amp; (Math.abs(1 - divStDev) &lt; 0.3)) {</span>
<span class="nc bnc" id="L414" title="All 2 branches missed.">            if (parameters.equals(compareFit.getParameters())) {</span>
<span class="nc" id="L415">                return 0;</span>
            } else {
<span class="nc" id="L417">                return 1;</span>
            }
        }

<span class="nc" id="L421">        return -1;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>