<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>AbstractBlobScaleFinder.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Jacoco Report</a> &gt; <a href="index.source.html" class="el_package">algorithms.imageProcessing</a> &gt; <span class="el_source">AbstractBlobScaleFinder.java</span></div><h1>AbstractBlobScaleFinder.java</h1><pre class="source lang-java linenums">package algorithms.imageProcessing;

import algorithms.compGeometry.NearestPoints;
import algorithms.imageProcessing.util.AngleUtil;
import algorithms.misc.MiscMath;
import algorithms.util.PairInt;
import algorithms.util.PairIntArray;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.Set;
import java.util.logging.Logger;

/**
 *
 * @author nichole
 */
<span class="pc bpc" id="L18" title="1 of 2 branches missed.">public abstract class AbstractBlobScaleFinder {</span>
    
<span class="fc" id="L20">    protected Logger log = Logger.getLogger(this.getClass().getName());</span>
    
<span class="fc" id="L22">    protected boolean debug = false;</span>

    public void setToDebug() {
<span class="fc" id="L25">        debug = true;</span>
<span class="fc" id="L26">    }</span>
    
    protected String printToString(List&lt;FeatureComparisonStat&gt; compStats) {
        
<span class="nc" id="L30">        StringBuilder sb = new StringBuilder();</span>
        
<span class="nc bnc" id="L32" title="All 2 branches missed.">        for (FeatureComparisonStat compStat : compStats) {</span>
            
<span class="nc" id="L34">            sb.append(String.format(</span>
            &quot; (%d,%d) (%d,%d) theta1=%.0f theta2=%.0f intSqDiff=%.1f(%.1f)&quot;, 
<span class="nc" id="L36">            compStat.getImg1Point().getX(), compStat.getImg1Point().getY(), </span>
<span class="nc" id="L37">            compStat.getImg2Point().getX(), compStat.getImg2Point().getY(), </span>
<span class="nc" id="L38">            compStat.getImg1PointRotInDegrees(), </span>
<span class="nc" id="L39">            compStat.getImg2PointRotInDegrees(), </span>
<span class="nc" id="L40">            compStat.getSumIntensitySqDiff(), </span>
<span class="nc" id="L41">            compStat.getImg2PointIntensityErr()));</span>
<span class="nc" id="L42">        }</span>
        
<span class="nc" id="L44">        return sb.toString();</span>
    }

    protected void removeOutliers(List&lt;FeatureComparisonStat&gt; compStats) {
        
<span class="nc bnc" id="L49" title="All 2 branches missed.">        if (compStats.size() &lt; 2) {</span>
<span class="nc" id="L50">            return;</span>
        }
        
        //TODO: improve w/ a more robust outlier removal
<span class="nc" id="L54">        double[] errDivInt = new double[compStats.size()];</span>
        
<span class="nc" id="L56">        float[] weights = new float[compStats.size()];</span>
        
<span class="nc" id="L58">        double sum = 0;</span>
        
<span class="nc bnc" id="L60" title="All 2 branches missed.">        for (int i = 0; i &lt; compStats.size(); ++i) {</span>
            
<span class="nc" id="L62">            FeatureComparisonStat compStat = compStats.get(i);</span>
            
<span class="nc" id="L64">            weights[i] = compStat.getSumIntensitySqDiff();</span>
            
<span class="nc" id="L66">            sum += weights[i];</span>
            
<span class="nc" id="L68">            errDivInt[i] = compStat.getImg2PointIntensityErr() </span>
<span class="nc" id="L69">                / compStat.getSumIntensitySqDiff();</span>
        }
        
<span class="nc bnc" id="L72" title="All 2 branches missed.">        if (sum &gt; 0) {</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">            for (int i = 0; i &lt; compStats.size(); ++i) {</span>

<span class="nc" id="L75">                double div = (sum - weights[i]) / ((compStats.size() - 1) * sum);</span>

<span class="nc" id="L77">                weights[i] = (float) div;</span>
            }
        } else {
<span class="nc" id="L80">            float a = 1.f/weights.length;</span>
<span class="nc" id="L81">            Arrays.fill(weights, a);</span>
<span class="nc" id="L82">            Arrays.fill(errDivInt, 0);</span>
        }
        
<span class="nc" id="L85">        float[] wghtsMeanAndStDev = MiscMath.getAvgAndStDev(weights);</span>
        
<span class="nc" id="L87">        float maxWeight = MiscMath.findMax(weights);</span>
        
        /*
        if all stats have intensities &lt; 5 times their errors and
        if the stdev is approx 0.15 times the mean or less, should filter here
         */
<span class="nc" id="L93">        boolean doNotFilter = true;</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">        if ((wghtsMeanAndStDev[1] / wghtsMeanAndStDev[0]) &gt; 0.15) {</span>
<span class="nc" id="L95">            doNotFilter = false;</span>
        }
<span class="nc bnc" id="L97" title="All 2 branches missed.">        if (doNotFilter) {</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">            for (int i = 0; i &lt; errDivInt.length; ++i) {</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">                if (errDivInt[i] &lt; 5) {</span>
<span class="nc" id="L100">                    doNotFilter = false;</span>
<span class="nc" id="L101">                    break;</span>
                }
            }
        }
        //TODO: may need revision
<span class="nc bnc" id="L106" title="All 4 branches missed.">        if (doNotFilter &amp;&amp; (weights.length &lt;= 4)) {</span>
<span class="nc" id="L107">            return;</span>
        }
        
<span class="nc" id="L110">        List&lt;FeatureComparisonStat&gt; filteredCompStats = </span>
            new ArrayList&lt;FeatureComparisonStat&gt;();
        
<span class="nc bnc" id="L113" title="All 2 branches missed.">        for (int i = 0; i &lt; compStats.size(); ++i) {</span>
<span class="nc" id="L114">            float w = weights[i];</span>
<span class="nc" id="L115">            float diffW = Math.abs(maxWeight - w);</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">            if (diffW &lt; (1.5 * wghtsMeanAndStDev[1])) {</span>
<span class="nc" id="L117">                filteredCompStats.add(compStats.get(i));</span>
            }
        }
        
<span class="nc" id="L121">        compStats.clear();</span>
        
<span class="nc" id="L123">        compStats.addAll(filteredCompStats);</span>
<span class="nc" id="L124">    }</span>

    protected float[] calculateThetaDiff(List&lt;FeatureComparisonStat&gt; compStats) {
        
<span class="nc bnc" id="L128" title="All 4 branches missed.">        if (compStats == null || compStats.isEmpty()) {</span>
<span class="nc" id="L129">            return null;</span>
        }
        
<span class="nc" id="L132">        float[] values = new float[compStats.size()];</span>
        
<span class="nc bnc" id="L134" title="All 2 branches missed.">        for (int i = 0; i &lt; compStats.size(); ++i) {</span>
            
<span class="nc" id="L136">            FeatureComparisonStat stat = compStats.get(i);</span>
        
            //NOTE: it's possible that the diff should be (360-d1)+d2 when d1&gt;d2
<span class="nc" id="L139">            float diff = AngleUtil.getAngleDifference(</span>
<span class="nc" id="L140">                stat.getImg1PointRotInDegrees(), stat.getImg2PointRotInDegrees());</span>
            
<span class="nc" id="L142">            values[i] = diff;</span>
        }
        
<span class="nc" id="L145">        return values;</span>
    }

    protected float calculateDiffThetaMean(List&lt;FeatureComparisonStat&gt; 
        comparisonStats) {
        
<span class="nc" id="L151">        float[] values = calculateThetaDiff(comparisonStats);</span>
        
<span class="nc bnc" id="L153" title="All 4 branches missed.">        if (values == null || values.length == 0) {</span>
<span class="nc" id="L154">            return Float.POSITIVE_INFINITY;</span>
        }
        
<span class="nc" id="L157">        double sum = 0;</span>
        
<span class="nc bnc" id="L159" title="All 2 branches missed.">        for (int i = 0; i &lt; values.length; ++i) {</span>
<span class="nc" id="L160">            sum += values[i];</span>
        }
        
<span class="nc" id="L163">        return (float) (sum / ((float) values.length));</span>
    }
    
    protected boolean rotationIsConsistent(TransformationParameters params, 
        List&lt;FeatureComparisonStat&gt; comparisonStats, float tolerance) {
                
<span class="nc bnc" id="L169" title="All 4 branches missed.">        if (comparisonStats == null || comparisonStats.isEmpty()) {</span>
<span class="nc" id="L170">            return false;</span>
        }
        
<span class="nc" id="L173">        float rotationInDegrees = params.getRotationInDegrees();</span>
        
<span class="nc bnc" id="L175" title="All 2 branches missed.">        for (FeatureComparisonStat stat : comparisonStats) {</span>
            
<span class="nc" id="L177">            float a1 = stat.getImg1PointRotInDegrees();</span>
            
<span class="nc" id="L179">            float a2 = stat.getImg2PointRotInDegrees();</span>
            
<span class="nc" id="L181">            float theta = AngleUtil.getAngleDifference(a1, a2);</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">            if (theta &lt; 0) {</span>
<span class="nc" id="L183">                theta += 360;</span>
            }
            
<span class="nc" id="L186">            float diff = AngleUtil.getAngleDifference(theta, rotationInDegrees);</span>
            
<span class="nc bnc" id="L188" title="All 2 branches missed.">            if (Math.abs(diff) &gt; tolerance) {</span>
                
<span class="nc bnc" id="L190" title="All 2 branches missed.">                if (a1 &gt; a2) {</span>
                    
<span class="nc" id="L192">                    theta = (360.f - a1) + a2;</span>
                    
<span class="nc" id="L194">                    diff = AngleUtil.getAngleDifference(theta, rotationInDegrees);</span>
                    
<span class="nc bnc" id="L196" title="All 2 branches missed.">                    if (Math.abs(diff) &gt; tolerance) {</span>
<span class="nc" id="L197">                        return false;</span>
                    }
                    
<span class="nc bnc" id="L200" title="All 2 branches missed.">                } else if (a1 &lt; a2) {</span>
                    
<span class="nc" id="L202">                    theta = a2 - a1;</span>
                    
<span class="nc" id="L204">                    diff = AngleUtil.getAngleDifference(theta, rotationInDegrees);</span>
                    
<span class="nc bnc" id="L206" title="All 2 branches missed.">                    if (Math.abs(diff) &gt; tolerance) {</span>
<span class="nc" id="L207">                        return false;</span>
                    } 
                }
            }
<span class="nc" id="L211">        }</span>
            
<span class="nc" id="L213">        return true;</span>
    }
    
    public boolean areSimilar(TransformationParameters params0, 
        TransformationParameters params1, float toleranceTranslation) {
        
<span class="nc" id="L219">        MatchedPointsTransformationCalculator tc = new MatchedPointsTransformationCalculator();</span>
        
<span class="nc bnc" id="L221" title="All 2 branches missed.">        if (tc.areSimilarByScaleAndRotation(params0, params1)) {</span>
            
<span class="nc bnc" id="L223" title="All 4 branches missed.">            assert(params0.getOriginX() == params1.getOriginX());</span>
<span class="nc bnc" id="L224" title="All 4 branches missed.">            assert(params0.getOriginY() == params1.getOriginY());</span>
            
<span class="nc" id="L226">            float diffX = params0.getTranslationX() - params1.getTranslationX();</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">            if (Math.abs(diffX) &gt; toleranceTranslation) {</span>
<span class="nc" id="L228">                return false;</span>
            }
<span class="nc" id="L230">            float diffY = params0.getTranslationY() - params1.getTranslationY();</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">            if (Math.abs(diffY) &gt; toleranceTranslation) {</span>
<span class="nc" id="L232">                return false;</span>
            }

<span class="nc" id="L235">            return true;</span>
        }
        
<span class="nc" id="L238">        return false;</span>
    }

    protected &lt;T extends CornerRegion&gt; int countMaxMatchable(
        List&lt;List&lt;T&gt;&gt; corners1List, List&lt;List&lt;T&gt;&gt; corners2List) {
        
<span class="nc" id="L244">        int n1 = 0;</span>
<span class="nc" id="L245">        int n2 = 0;</span>
        
<span class="nc bnc" id="L247" title="All 2 branches missed.">        for (List&lt;T&gt; list : corners1List) {</span>
<span class="nc" id="L248">            n1 += list.size();</span>
<span class="nc" id="L249">        }</span>
        
<span class="nc bnc" id="L251" title="All 2 branches missed.">        for (List&lt;T&gt; list : corners2List) {</span>
<span class="nc" id="L252">            n2 += list.size();</span>
<span class="nc" id="L253">        }</span>
        
<span class="nc" id="L255">        return Math.max(n1, n2);</span>
    }
    
    protected &lt;T extends CornerRegion&gt; int[] convertToXPoints(
        List&lt;List&lt;T&gt;&gt; cornersList) {
        
<span class="nc" id="L261">        int n = 0;</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">        for (List&lt;T&gt; list : cornersList) {</span>
<span class="nc" id="L263">            n += list.size();</span>
<span class="nc" id="L264">        }</span>
        
<span class="nc" id="L266">        int[] x = new int[n];</span>
<span class="nc" id="L267">        n = 0;</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">        for (List&lt;T&gt; list : cornersList) {</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">            for (T cr : list) {</span>
<span class="nc" id="L270">                x[n] = cr.getX()[cr.getKMaxIdx()];</span>
<span class="nc" id="L271">                n++;</span>
<span class="nc" id="L272">            }</span>
<span class="nc" id="L273">        }</span>
        
<span class="nc" id="L275">        return x;</span>
    }
    
    protected &lt;T extends CornerRegion&gt; int[] convertToYPoints(
        List&lt;List&lt;T&gt;&gt; cornersList) {
        
<span class="nc" id="L281">        int n = 0;</span>
<span class="nc bnc" id="L282" title="All 2 branches missed.">        for (List&lt;T&gt; list : cornersList) {</span>
<span class="nc" id="L283">            n += list.size();</span>
<span class="nc" id="L284">        }</span>
        
<span class="nc" id="L286">        int[] y = new int[n];</span>
<span class="nc" id="L287">        n = 0;</span>
<span class="nc bnc" id="L288" title="All 2 branches missed.">        for (List&lt;T&gt; list : cornersList) {</span>
<span class="nc bnc" id="L289" title="All 2 branches missed.">            for (T cr : list) {</span>
<span class="nc" id="L290">                y[n] = cr.getY()[cr.getKMaxIdx()];</span>
<span class="nc" id="L291">                n++;</span>
<span class="nc" id="L292">            }</span>
<span class="nc" id="L293">        }</span>
        
<span class="nc" id="L295">        return y;</span>
    }

    protected &lt;T extends CornerRegion&gt; int evaluate(TransformationParameters params, 
        List&lt;List&lt;T&gt;&gt; corners1List, List&lt;List&lt;T&gt;&gt; corners2List, 
        int tolTransXY) {
        
        //TODO: move this method to a class for utility methods
        
<span class="nc" id="L304">        int nMatched = 0;</span>
        
<span class="nc" id="L306">        int[] xPoints = convertToXPoints(corners2List);</span>
<span class="nc" id="L307">        int[] yPoints = convertToYPoints(corners2List);</span>
        
<span class="nc" id="L309">        Transformer transformer = new Transformer();</span>
        
<span class="nc" id="L311">        NearestPoints np = new NearestPoints(xPoints, yPoints);</span>
        
<span class="nc bnc" id="L313" title="All 2 branches missed.">        for (int i = 0; i &lt; corners1List.size(); ++i) {</span>
            
<span class="nc" id="L315">            List&lt;T&gt; corners1 = corners1List.get(i);</span>
            
<span class="nc bnc" id="L317" title="All 2 branches missed.">            for (int ii = 0; ii &lt; corners1.size(); ++ii) {</span>
                
<span class="nc" id="L319">                T cr = corners1.get(ii);</span>
                
<span class="nc" id="L321">                double[] xyTr = transformer.applyTransformation(params, </span>
<span class="nc" id="L322">                    cr.getX()[cr.getKMaxIdx()], cr.getY()[cr.getKMaxIdx()]);</span>
                
<span class="nc" id="L324">                Set&lt;Integer&gt; indexes = np.findNeighborIndexes(</span>
<span class="nc" id="L325">                    (int)Math.round(xyTr[0]), (int)Math.round(xyTr[1]), </span>
                    tolTransXY);
                
<span class="nc bnc" id="L328" title="All 4 branches missed.">                if (indexes != null &amp;&amp; indexes.size() &gt; 0) {</span>
<span class="nc" id="L329">                    nMatched++;</span>
                }
            }
        }
        
<span class="nc" id="L334">        return nMatched;</span>
    }
    
    protected int[] convertToXPoints2(List&lt;List&lt;CurvatureScaleSpaceContour&gt;&gt; cList) {
        
<span class="nc" id="L339">        int n = 0;</span>
<span class="nc bnc" id="L340" title="All 2 branches missed.">        for (List&lt;CurvatureScaleSpaceContour&gt; list : cList) {</span>
<span class="nc" id="L341">            n += list.size();</span>
<span class="nc" id="L342">        }</span>
        
<span class="nc" id="L344">        int[] x = new int[n];</span>
<span class="nc" id="L345">        n = 0;</span>
<span class="nc bnc" id="L346" title="All 2 branches missed.">        for (List&lt;CurvatureScaleSpaceContour&gt; list : cList) {</span>
<span class="nc bnc" id="L347" title="All 2 branches missed.">            for (CurvatureScaleSpaceContour cr : list) {</span>
<span class="nc" id="L348">                x[n] = cr.getPeakDetails()[0].getXCoord();</span>
<span class="nc" id="L349">                n++;</span>
<span class="nc" id="L350">            }</span>
<span class="nc" id="L351">        }</span>
        
<span class="nc" id="L353">        return x;</span>
    }
    
    protected int[] convertToYPoints2(List&lt;List&lt;CurvatureScaleSpaceContour&gt;&gt; cList) {
        
<span class="nc" id="L358">        int n = 0;</span>
<span class="nc bnc" id="L359" title="All 2 branches missed.">        for (List&lt;CurvatureScaleSpaceContour&gt; list : cList) {</span>
<span class="nc" id="L360">            n += list.size();</span>
<span class="nc" id="L361">        }</span>
        
<span class="nc" id="L363">        int[] y = new int[n];</span>
<span class="nc" id="L364">        n = 0;</span>
<span class="nc bnc" id="L365" title="All 2 branches missed.">        for (List&lt;CurvatureScaleSpaceContour&gt; list : cList) {</span>
<span class="nc bnc" id="L366" title="All 2 branches missed.">            for (CurvatureScaleSpaceContour cr : list) {</span>
<span class="nc" id="L367">                y[n] = cr.getPeakDetails()[0].getYCoord();</span>
<span class="nc" id="L368">                n++;</span>
<span class="nc" id="L369">            }</span>
<span class="nc" id="L370">        }</span>
        
<span class="nc" id="L372">        return y;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>